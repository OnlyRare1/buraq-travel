<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buraq Travel - Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* GLOBAL & ANIMATIONS */
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #042f2e 100%); overflow-x: hidden; }
        #initial-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom right, #059669, #0f766e); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease-out, visibility 0.8s; }
        .plane-loader { font-size: 4rem; color: white; animation: flyAround 2s infinite linear; }
        .loading-text { color: white; margin-top: 20px; font-size: 1.2rem; font-weight: 600; letter-spacing: 2px; animation: pulse 1.5s infinite; }
        .loading-bar { width: 200px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .loading-bar-fill { height: 100%; background: white; width: 0%; animation: fillBar 5s linear forwards; }
        @keyframes flyAround { 0% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-10px) rotate(-5deg); } 50% { transform: translateY(0) rotate(0deg); } 75% { transform: translateY(10px) rotate(5deg); } 100% { transform: translateY(0) rotate(0deg); } }
        @keyframes fillBar { 0% { width: 0%; } 100% { width: 100%; } }
        .content-hidden { opacity: 0; transform: translateY(20px); transition: opacity 0.8s ease-out, transform 0.8s ease-out; }
        .content-visible { opacity: 1; transform: translateY(0); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .nav-glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .flight-card { transition: all 0.3s ease; background: white; border: 1px solid #f3f4f6; }
        .flight-card:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border-color: #34d399; }
        .custom-input { transition: all 0.3s ease; }
        .custom-input:focus { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -1px rgba(16, 185, 129, 0.06); }
        .tab-active { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.4); transform: scale(1.05); }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; }
        .tab-inactive:hover { background-color: #e5e7eb; color: #1f2937; }
        .suggestions-list::-webkit-scrollbar { width: 6px; }
        .suggestions-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .suggestions-list::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        .loader-spin { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: bold; transition: all 0.2s; cursor: pointer; }
        .page-btn-active { background: #059669; color: white; box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.4); }
        .page-btn-inactive { background: white; color: #4b5563; border: 1px solid #e5e7eb; }
        .page-btn-inactive:hover { background: #f3f4f6; color: #1f2937; }
        .bg-pattern { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.1; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        .pulse-dot { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
    </style>
</head>
<body class="min-h-screen text-gray-800 antialiased selection:bg-green-200 selection:text-green-900">

    <div id="initial-loader">
        <div class="plane-loader"><i class="fas fa-plane"></i></div>
        <div class="loading-text">Starting Engines...</div>
        <div class="loading-bar"><div class="loading-bar-fill"></div></div>
        <p class="text-white/70 text-sm mt-2">Buraq Travel</p>
    </div>

    <div class="bg-pattern"></div>

    <div id="main-content" class="content-hidden flex flex-col min-h-screen">
        <nav class="nav-glass shadow-lg sticky top-0 z-50 transition-all duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex items-center transform hover:scale-105 transition-transform duration-300">
                        <a href="#" class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-green-600/30">
                                <i class="fas fa-plane-departure text-xl"></i>
                            </div>
                            <span class="font-bold text-gray-800 text-2xl tracking-tight">Buraq<span class="text-green-600">Travel</span></span>
                        </a>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center bg-gray-900/90 backdrop-blur text-white text-xs rounded-full px-4 py-1.5 border border-gray-700 shadow-xl">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2 pulse-dot"></span>
                            <span class="font-semibold tracking-wide">Live System</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-12 flex-grow">
            <div class="max-w-5xl mx-auto glass-panel rounded-3xl overflow-visible p-8 mb-12 relative z-40">
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4 border-b border-gray-100 pb-6">
                    <div>
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-1">Find your next adventure</h2>
                        <p class="text-gray-500 text-sm">Compare prices and book your flight instantly.</p>
                        <div class="flex flex-col sm:flex-row gap-3 mt-4">
                            <div class="flex items-center text-red-600 text-xs sm:text-sm font-bold bg-red-50 border border-red-100 px-3 py-1.5 rounded-full w-fit shadow-sm"><i class="fas fa-eye mr-2 animate-pulse"></i><span><span id="viewing-count">0</span> People are viewing this right now</span></div>
                            <div class="flex items-center text-red-600 text-xs sm:text-sm font-bold bg-red-50 border border-red-100 px-3 py-1.5 rounded-full w-fit shadow-sm"><i class="fas fa-fire-alt mr-2"></i><span><span id="sold-count">0</span> tickets sold in last 5 hours</span></div>
                        </div>
                    </div>
                    <div class="text-sm bg-gradient-to-r from-red-500 to-pink-600 text-white px-5 py-2 rounded-full font-bold animate-pulse shadow-lg shadow-red-500/30 flex items-center transform hover:-translate-y-1 transition-transform whitespace-nowrap"><i class="fas fa-tag mr-2"></i> FLAT 40% OFF EVERYTHING</div>
                </div>

                <div class="flex space-x-2 mb-8 bg-gray-100/50 p-1.5 rounded-xl w-fit backdrop-blur-sm">
                    <button type="button" onclick="setTripType('oneway')" id="tab-oneway" class="tab-active px-6 py-2.5 rounded-lg transition-all duration-300 text-sm">One Way</button>
                    <button type="button" onclick="setTripType('roundtrip')" id="tab-roundtrip" class="tab-inactive px-6 py-2.5 rounded-lg transition-all duration-300 text-sm">Round Trip</button>
                    <button type="button" onclick="setTripType('multicity')" id="tab-multicity" class="tab-inactive px-6 py-2.5 rounded-lg transition-all duration-300 text-sm">Multi-City</button>
                </div>
                
                <form id="searchForm" class="space-y-6" autocomplete="off">
                    <div id="standard-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="relative group">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">From</label>
                            <div class="relative"><div class="absolute left-4 top-3.5 text-gray-400 group-focus-within:text-green-600 transition-colors"><i class="fas fa-plane-departure text-lg"></i></div><input type="text" id="origin-input" placeholder="City or Airport" class="custom-input pl-12 pr-10 w-full py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-green-500 focus:border-green-500 uppercase font-bold text-gray-700 outline-none"><input type="hidden" id="origin" value=""><button type="button" onclick="clearInput('origin-input', 'origin')" class="absolute right-3 top-4 text-gray-300 hover:text-red-400 transition-colors"><i class="fas fa-times-circle"></i></button><div id="origin-loading" class="absolute right-10 top-4 hidden"><i class="fas fa-spinner fa-spin text-green-600"></i></div></div>
                            <ul id="origin-suggestions" class="suggestions-list absolute w-full bg-white border border-gray-100 rounded-xl shadow-2xl max-h-60 overflow-y-auto hidden z-50 mt-2"></ul>
                        </div>
                        <div class="relative group">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">To</label>
                            <div class="relative"><div class="absolute left-4 top-3.5 text-gray-400 group-focus-within:text-green-600 transition-colors"><i class="fas fa-plane-arrival text-lg"></i></div><input type="text" id="destination-input" placeholder="City or Airport" class="custom-input pl-12 pr-10 w-full py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-green-500 focus:border-green-500 uppercase font-bold text-gray-700 outline-none"><input type="hidden" id="destination" value=""><button type="button" onclick="clearInput('destination-input', 'destination')" class="absolute right-3 top-4 text-gray-300 hover:text-red-400 transition-colors"><i class="fas fa-times-circle"></i></button><div id="destination-loading" class="absolute right-10 top-4 hidden"><i class="fas fa-spinner fa-spin text-green-600"></i></div></div>
                            <ul id="destination-suggestions" class="suggestions-list absolute w-full bg-white border border-gray-100 rounded-xl shadow-2xl max-h-60 overflow-y-auto hidden z-50 mt-2"></ul>
                        </div>
                        <div class="relative group">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Departure</label>
                            <div class="relative"><div class="absolute left-4 top-3.5 text-gray-400 group-focus-within:text-green-600 transition-colors"><i class="far fa-calendar-alt text-lg"></i></div><input type="date" id="date" class="custom-input pl-12 w-full py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-green-500 focus:border-green-500 font-semibold text-gray-700 outline-none cursor-pointer" required></div>
                        </div>
                        <div class="relative hidden group" id="return-date-container">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Return</label>
                            <div class="relative"><div class="absolute left-4 top-3.5 text-gray-400 group-focus-within:text-green-600 transition-colors"><i class="far fa-calendar-check text-lg"></i></div><input type="date" id="return-date" class="custom-input pl-12 w-full py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-green-500 focus:border-green-500 font-semibold text-gray-700 outline-none cursor-pointer"></div>
                        </div>
                    </div>

                    <div id="multicity-container" class="hidden space-y-4">
                        <div id="segments-wrapper" class="space-y-4"></div>
                        <button type="button" onclick="addSegment()" class="text-sm text-green-700 font-bold hover:bg-green-50 flex items-center px-4 py-3 rounded-xl border-2 border-dashed border-green-200 hover:border-green-400 w-full justify-center transition-all"><i class="fas fa-plus-circle mr-2"></i> Add Another Flight</button>
                    </div>

                    <div class="flex flex-col md:flex-row items-center justify-between pt-8 border-t border-gray-100 mt-8 gap-4">
                        <div class="flex items-center bg-gray-50 px-4 py-3 rounded-xl border border-gray-200 hover:bg-white transition-colors cursor-pointer w-full md:w-auto">
                            <input id="useProxy" type="checkbox" class="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded cursor-pointer" checked>
                            <label for="useProxy" class="ml-3 block text-sm font-medium text-gray-600 cursor-pointer select-none">Use Proxy (Web App Mode)</label>
                        </div>
                        <button type="submit" class="w-full md:w-auto bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 text-white font-bold py-4 px-12 rounded-xl shadow-lg shadow-green-600/30 hover:shadow-green-600/50 transition duration-300 flex items-center justify-center transform hover:-translate-y-1 active:scale-95 text-lg"><i class="fas fa-search mr-2"></i><span id="btnText">Search Flights</span><div id="btnLoader" class="loader-spin ml-3 hidden"></div></button>
                    </div>
                </form>
            </div>

            <div id="errorContainer" class="max-w-5xl mx-auto hidden mb-8 relative z-0 animate-bounce">
                <div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-6 rounded-r-xl shadow-lg flex items-start" role="alert"><i class="fas fa-exclamation-circle mt-1 mr-4 text-2xl text-red-500"></i><div><p class="font-bold text-lg">Search Failed</p><div id="errorText" class="text-sm mt-1 opacity-80">Something went wrong.</div></div></div>
            </div>

            <div id="resultsArea" class="max-w-5xl mx-auto space-y-6 relative z-0"></div>

            <div id="paginationContainer" class="max-w-5xl mx-auto mt-8 hidden relative z-0 pb-12">
                <div class="flex justify-center items-center space-x-2 bg-white/90 backdrop-blur p-4 rounded-xl w-fit mx-auto shadow-lg border border-gray-200">
                    <button id="prevBtn" onclick="changePage('prev')" class="page-btn page-btn-inactive"><i class="fas fa-chevron-left"></i></button>
                    <div id="pageNumbers" class="flex space-x-2"></div>
                    <button id="nextBtn" onclick="changePage('next')" class="page-btn page-btn-inactive"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <footer class="mt-auto border-t border-white/10 bg-black/30 backdrop-blur-md text-white py-8 relative z-40">
            <div class="max-w-7xl mx-auto px-4 flex flex-col items-center justify-center text-center">
                <h3 class="text-lg font-semibold mb-3 text-white/90">Need help with your booking?</h3>
                <a href="https://wa.me/923306265440?text=Hi,%20I%20need%20help%20with%20flight%20information" target="_blank" class="group flex items-center gap-3 bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-full font-bold transition-all shadow-lg hover:shadow-green-500/40 transform hover:-translate-y-1"><i class="fab fa-whatsapp text-2xl group-hover:animate-bounce"></i><span>Just Contact Us On Whatsapp</span></a>
                <p class="text-white/30 text-xs mt-8">&copy; 2025 Buraq Travel. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // --- DYNAMIC STATS ---
        function updateStats() {
            const viewingEl = document.getElementById('viewing-count');
            function refreshViewing() { viewingEl.textContent = Math.floor(Math.random() * (950 - 10 + 1)) + 10; }
            setInterval(refreshViewing, 3000); refreshViewing(); 
            const soldEl = document.getElementById('sold-count');
            soldEl.textContent = Math.floor(Math.random() * (250 - 20 + 1)) + 20;
        }

        // --- 5 SECOND LOADING SCREEN ---
        window.addEventListener('load', () => {
            const loader = document.getElementById('initial-loader');
            const content = document.getElementById('main-content');
            updateStats();
            setTimeout(() => {
                loader.style.opacity = '0';
                loader.style.visibility = 'hidden';
                content.classList.remove('content-hidden');
                content.classList.add('content-visible');
            }, 5000);
        });

        // --- CONFIG ---
        const API_KEY = "JXEgEvgYfpnaGDPAqbCHA71tTrUgSsu3";
        const API_SECRET = "WliWhvsqY9JVXvQX";
        const BASE_URL = "https://api.amadeus.com";
        const AUTH_URL = `${BASE_URL}/v1/security/oauth2/token`;
        const SEARCH_URL_GET = `${BASE_URL}/v2/shopping/flight-offers`;
        const SEARCH_URL_POST = `${BASE_URL}/v2/shopping/flight-offers`; 
        const LOCATION_URL = `${BASE_URL}/v1/reference-data/locations`;
        const PROXY_URL = "https://corsproxy.io/?"; 
        // UPDATED TO RELATIVE PATH
        const LOCAL_SCRAPER_URL = "/api/search";

        // --- GLOBAL STATE ---
        let allFlightsData = []; 
        let currentPage = 1;
        const itemsPerPage = 15; 
        
        let cachedToken = null;
        let tokenExpiry = 0;
        let currentTripType = 'oneway';
        const ACTIVE_DISCOUNT_PERCENTAGE = 0.40; 

        const today = new Date();
        const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
        const dayAfter = new Date(today); dayAfter.setDate(today.getDate() + 7);
        document.getElementById('date').valueAsDate = tomorrow;
        document.getElementById('return-date').valueAsDate = dayAfter;

        function clearInput(inputId, hiddenId) {
            document.getElementById(inputId).value = '';
            document.getElementById(hiddenId).value = '';
            document.getElementById(inputId).focus();
        }

        function setTripType(type) {
            currentTripType = type;
            ['oneway', 'roundtrip', 'multicity'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === type) { btn.className = "tab-active px-6 py-2.5 rounded-lg transition-all duration-300 text-sm shadow-md"; } 
                else { btn.className = "tab-inactive px-6 py-2.5 rounded-lg transition-all duration-300 text-sm hover:bg-gray-200"; }
            });
            const standardFields = document.getElementById('standard-fields');
            const returnDateContainer = document.getElementById('return-date-container');
            const multiCityContainer = document.getElementById('multicity-container');
            if (type === 'oneway') {
                standardFields.classList.remove('hidden'); returnDateContainer.classList.add('hidden'); multiCityContainer.classList.add('hidden'); document.getElementById('return-date').required = false;
            } else if (type === 'roundtrip') {
                standardFields.classList.remove('hidden'); returnDateContainer.classList.remove('hidden'); multiCityContainer.classList.add('hidden'); document.getElementById('return-date').required = true;
            } else if (type === 'multicity') {
                standardFields.classList.add('hidden'); multiCityContainer.classList.remove('hidden'); document.getElementById('return-date').required = false;
                if(document.getElementById('segments-wrapper').children.length === 0) { addSegment(); addSegment(); }
            }
        }

        function setupAutocomplete(inputElement, listId, loadingId, hiddenInputId) {
            let debounceTimer;
            const listElement = document.getElementById(listId);
            const loadingElement = document.getElementById(loadingId);
            const hiddenInput = document.getElementById(hiddenInputId);

            inputElement.addEventListener('input', (e) => {
                const keyword = e.target.value;
                if(!keyword && hiddenInput) hiddenInput.value = "";
                clearTimeout(debounceTimer);
                if (keyword.length < 2) { listElement.classList.add('hidden'); return; }

                debounceTimer = setTimeout(async () => {
                    if(loadingElement) loadingElement.classList.remove('hidden');
                    try {
                        const locations = await searchLocations(keyword);
                        renderSuggestions(locations, listElement, inputElement, hiddenInput);
                    } catch (error) { console.error("Location search error", error); } 
                    finally { if(loadingElement) loadingElement.classList.add('hidden'); }
                }, 400);
            });
            document.addEventListener('click', (e) => { if (!inputElement.contains(e.target) && !listElement.contains(e.target)) { listElement.classList.add('hidden'); } });
        }

        async function searchLocations(keyword) {
            const useProxy = document.getElementById('useProxy').checked;
            const token = await getAccessToken(useProxy);
            const urlObj = new URL(LOCATION_URL);
            urlObj.searchParams.append('subType', 'AIRPORT,CITY');
            urlObj.searchParams.append('keyword', keyword);
            urlObj.searchParams.append('view', 'LIGHT');
            const endpoint = useProxy ? PROXY_URL + encodeURIComponent(urlObj.toString()) : urlObj.toString();
            const data = await fetchAndParse(endpoint, { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } });
            return data.data || [];
        }

        function renderSuggestions(locations, listElement, inputElement, hiddenInput) {
            listElement.innerHTML = '';
            if (locations.length === 0) { listElement.classList.add('hidden'); return; }
            locations.forEach(loc => {
                const li = document.createElement('li');
                li.className = "px-4 py-3 hover:bg-green-50 cursor-pointer border-b border-gray-100 last:border-b-0 flex justify-between items-center transition-colors group";
                const icon = loc.subType === 'AIRPORT' ? '<i class="fas fa-plane text-gray-400 group-hover:text-green-600 mr-2 transition-colors"></i>' : '<i class="fas fa-city text-gray-400 group-hover:text-green-600 mr-2 transition-colors"></i>';
                li.innerHTML = `<div class="flex flex-col"><span class="font-bold text-gray-700 text-sm">${icon}${loc.name}</span><span class="text-xs text-gray-500 ml-6">${loc.address.cityName}, ${loc.address.countryName}</span></div><span class="bg-gray-100 group-hover:bg-green-100 text-gray-600 group-hover:text-green-700 text-xs font-bold px-2 py-1 rounded transition-colors">${loc.iataCode}</span>`;
                li.addEventListener('click', () => {
                    inputElement.value = `${loc.name} (${loc.iataCode})`;
                    if(hiddenInput) hiddenInput.value = loc.iataCode;
                    listElement.classList.add('hidden');
                });
                listElement.appendChild(li);
            });
            listElement.classList.remove('hidden');
        }

        setupAutocomplete(document.getElementById('origin-input'), 'origin-suggestions', 'origin-loading', 'origin');
        setupAutocomplete(document.getElementById('destination-input'), 'destination-suggestions', 'destination-loading', 'destination');

        let segmentCount = 0;
        function addSegment() {
            segmentCount++;
            const wrapper = document.getElementById('segments-wrapper');
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50/50 p-6 rounded-xl border border-gray-200 relative animate-fade-in hover:bg-white hover:shadow-md transition-all duration-300";
            div.innerHTML = `
                <div class="relative group"><label class="text-xs font-bold text-gray-500 uppercase mb-1 block">From</label><input type="text" id="seg-origin-input-${segmentCount}" placeholder="City" class="custom-input w-full p-3 border border-gray-300 rounded-lg uppercase text-sm font-bold focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"><input type="hidden" id="seg-origin-${segmentCount}"><ul id="seg-origin-suggestions-${segmentCount}" class="suggestions-list absolute w-full bg-white border border-gray-200 rounded-b-lg shadow-xl max-h-40 overflow-y-auto hidden z-50 mt-1"></ul></div>
                <div class="relative group"><label class="text-xs font-bold text-gray-500 uppercase mb-1 block">To</label><input type="text" id="seg-dest-input-${segmentCount}" placeholder="City" class="custom-input w-full p-3 border border-gray-300 rounded-lg uppercase text-sm font-bold focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"><input type="hidden" id="seg-dest-${segmentCount}"><ul id="seg-dest-suggestions-${segmentCount}" class="suggestions-list absolute w-full bg-white border border-gray-200 rounded-b-lg shadow-xl max-h-40 overflow-y-auto hidden z-50 mt-1"></ul></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Date</label><input type="date" id="seg-date-${segmentCount}" class="custom-input w-full p-3 border border-gray-300 rounded-lg text-sm font-bold outline-none focus:ring-2 focus:ring-green-500"></div>`;
            wrapper.appendChild(div);
            setupAutocomplete(document.getElementById(`seg-origin-input-${segmentCount}`), `seg-origin-suggestions-${segmentCount}`, null, `seg-origin-${segmentCount}`);
            setupAutocomplete(document.getElementById(`seg-dest-input-${segmentCount}`), `seg-dest-suggestions-${segmentCount}`, null, `seg-dest-${segmentCount}`);
        }

        async function getAccessToken(useProxy) {
            const now = Date.now() / 1000;
            if (cachedToken && tokenExpiry > now) return cachedToken;
            const endpoint = useProxy ? PROXY_URL + encodeURIComponent(AUTH_URL) : AUTH_URL;
            const params = new URLSearchParams();
            params.append('grant_type', 'client_credentials');
            params.append('client_id', API_KEY);
            params.append('client_secret', API_SECRET);
            try {
                const data = await fetchAndParse(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params });
                cachedToken = data.access_token;
                tokenExpiry = (Date.now() / 1000) + data.expires_in - 60;
                return data.access_token;
            } catch (err) { throw err; }
        }

        async function fetchAndParse(url, options) {
            if (!options.headers) options.headers = {};
            const response = await fetch(url, options);
            const text = await response.text();
            try {
                const data = JSON.parse(text);
                if (!response.ok) throw new Error(data.error_description || "API Error");
                return data;
            } catch (e) {
                if (!response.ok) throw new Error(response.statusText);
                throw e;
            }
        }

        async function fetchScrapers(origin, destination, date) {
            try {
                const response = await fetch(LOCAL_SCRAPER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ origin, destination, date })
                });
                if(!response.ok) return [];
                return await response.json();
            } catch (e) {
                console.warn("Local scraper failed", e);
                return [];
            }
        }

        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearUI();
            showLoading(true);
            const useProxy = document.getElementById('useProxy').checked;

            try {
                let origin = document.getElementById('origin').value || document.getElementById('origin-input').value.toUpperCase().substring(0,3);
                let destination = document.getElementById('destination').value || document.getElementById('destination-input').value.toUpperCase().substring(0,3);
                const date = document.getElementById('date').value;

                const token = await getAccessToken(useProxy);
                
                let apiPromise;
                if (currentTripType === 'multicity') { apiPromise = searchMultiCity(token, useProxy); } 
                else { apiPromise = searchStandard(token, useProxy, origin, destination, date); }
                
                let scraperPromise = Promise.resolve([]);
                if (currentTripType !== 'multicity') { scraperPromise = fetchScrapers(origin, destination, date); }

                const [apiFlights, scraperFlights] = await Promise.allSettled([apiPromise, scraperPromise]);

                let tempFlights = [];
                
                if(scraperFlights.status === 'fulfilled' && scraperFlights.value.length > 0) {
                    const converted = scraperFlights.value.map(s => ({
                        isScraper: true,
                        price: { total: s.price, currency: s.currency },
                        itineraries: [{
                            duration: s.duration,
                            segments: [{
                                carrierCode: s.airline,
                                number: s.flight_no,
                                departure: { iataCode: s.origin, at: `2024-01-01T${s.depart_time}:00` },
                                arrival: { iataCode: s.destination, at: `2024-01-01T${s.arrive_time}:00` }
                            }]
                        }]
                    }));
                    tempFlights = [...converted];
                }

                if(apiFlights.status === 'fulfilled' && apiFlights.value) {
                    tempFlights = [...tempFlights, ...apiFlights.value];
                }

                allFlightsData = tempFlights;
                currentPage = 1;
                renderPage(1);

            } catch (error) { showError(error.message); } 
            finally { showLoading(false); }
        });

        async function searchStandard(token, useProxy, origin, destination, date) {
            const urlObj = new URL(SEARCH_URL_GET);
            urlObj.searchParams.append('originLocationCode', origin);
            urlObj.searchParams.append('destinationLocationCode', destination);
            urlObj.searchParams.append('departureDate', date);
            if (currentTripType === 'roundtrip') { urlObj.searchParams.append('returnDate', document.getElementById('return-date').value); }
            urlObj.searchParams.append('adults', '1');
            urlObj.searchParams.append('max', '30'); 
            urlObj.searchParams.append('currencyCode', 'PKR');
            const endpoint = useProxy ? PROXY_URL + encodeURIComponent(urlObj.toString()) : urlObj.toString();
            const data = await fetchAndParse(endpoint, { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } });
            return data.data;
        }

        async function searchMultiCity(token, useProxy) {
            const originDestinations = [];
            const wrapper = document.getElementById('segments-wrapper');
            const rows = wrapper.children;
            for (let i = 0; i < rows.length; i++) {
                const idx = i + 1;
                let origin = document.getElementById(`seg-origin-${idx}`).value || document.getElementById(`seg-origin-input-${idx}`).value.toUpperCase().substring(0,3);
                let dest = document.getElementById(`seg-dest-${idx}`).value || document.getElementById(`seg-dest-input-${idx}`).value.toUpperCase().substring(0,3);
                const date = document.getElementById(`seg-date-${idx}`).value;
                if(origin && dest && date) {
                    originDestinations.push({ id: (i + 1).toString(), originLocationCode: origin, destinationLocationCode: dest, departureDateTimeRange: { date: date } });
                }
            }
            const endpoint = useProxy ? PROXY_URL + encodeURIComponent(SEARCH_URL_POST) : SEARCH_URL_POST;
            const data = await fetchAndParse(endpoint, { 
                method: 'POST', 
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ currencyCode: "PKR", originDestinations, travelers: [{ id: "1", travelerType: "ADULT" }], sources: ["GDS"] })
            });
            return data.data;
        }

        function renderPage(page) {
            const container = document.getElementById('resultsArea');
            const paginationContainer = document.getElementById('paginationContainer');
            if (!allFlightsData || allFlightsData.length === 0) {
                container.innerHTML = `<div class="bg-white/90 backdrop-blur p-12 rounded-3xl shadow-lg text-center border border-gray-100 animate-fade-in-up"><div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"><i class="fas fa-plane-slash text-gray-400 text-2xl"></i></div><h3 class="text-xl font-bold text-gray-800">No Flights Found</h3><p class="text-gray-500 mt-2">Check your search criteria or ensure local scraper is active.</p></div>`;
                paginationContainer.classList.add('hidden');
                return;
            }
            container.innerHTML = '';
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageFlights = allFlightsData.slice(startIndex, endIndex);

            pageFlights.forEach((flight, index) => {
                const originalPrice = parseFloat(flight.price.total);
                const finalPrice = (originalPrice * (1 - ACTIVE_DISCOUNT_PERCENTAGE)).toFixed(0); 

                let legsHtml = "";
                flight.itineraries.forEach((itinerary) => {
                    const segments = itinerary.segments;
                    const firstSeg = segments[0];
                    const lastSeg = segments[segments.length - 1];
                    const airlineCode = firstSeg.carrierCode;
                    const duration = itinerary.duration.replace("PT", "").toLowerCase();
                    const airlines = { 'BA': 'British Airways', 'PK': 'PIA', 'PA': 'Airblue', 'FZ': 'Flydubai', 'NL': 'Fly Jinnah', '9P': 'Fly Jinnah', 'PF': 'Air Sial' };
                    let airlineName = airlines[airlineCode] || airlineCode;
                    if(flight.isScraper) airlineName = airlineCode; 

                    legsHtml += `
                        <div class="mb-4 last:mb-0 border-b last:border-0 border-gray-100 pb-3 last:pb-0">
                            <div class="flex justify-between items-center text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">
                                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded">Flight</span>
                                <span class="flex items-center text-gray-800 font-bold"><i class="fas fa-plane mr-2 text-green-500"></i> ${airlineName}</span>
                            </div>
                            <div class="flex items-center text-gray-700 justify-between mt-2">
                                <div class="text-center w-20"><p class="text-2xl font-black text-gray-800">${firstSeg.departure.at.split('T')[1].substr(0,5)}</p><p class="text-xs font-bold text-gray-400 mt-1">${firstSeg.departure.iataCode}</p></div>
                                <div class="flex-1 px-4 flex flex-col items-center"><p class="text-[10px] text-gray-400 mb-1 font-medium uppercase tracking-wider">${duration}</p><div class="w-full flex items-center relative"><div class="h-[2px] bg-gray-200 flex-1"></div><i class="fas fa-plane text-green-400 text-sm mx-2 transform rotate-90 md:rotate-0"></i><div class="h-[2px] bg-gray-200 flex-1"></div></div><p class="text-[10px] text-green-600 font-bold mt-1 bg-green-50 px-2 py-0.5 rounded-full">${segments.length > 1 ? (segments.length-1) + " Stop(s)" : "Direct"}</p></div>
                                <div class="text-center w-20"><p class="text-2xl font-black text-gray-800">${lastSeg.arrival.at.split('T')[1].substr(0,5)}</p><p class="text-xs font-bold text-gray-400 mt-1">${lastSeg.arrival.iataCode}</p></div>
                            </div>
                        </div>`;
                });

                const badge = flight.isScraper 
                    ? '<div class="absolute top-0 right-0 bg-gradient-to-l from-green-600 to-green-500 text-white text-[10px] px-3 py-1 rounded-bl-xl font-bold z-10 shadow-sm uppercase tracking-wider">LOCAL PARTNER</div>'
                    : '<div class="absolute top-0 right-0 bg-gradient-to-l from-blue-600 to-blue-500 text-white text-[10px] px-3 py-1 rounded-bl-xl font-bold z-10 shadow-sm uppercase tracking-wider">Direct API</div>';

                const card = `
                    <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl p-0 flight-card transition-all duration-300 overflow-hidden border border-gray-100 relative group animate-fade-in-up" style="animation-delay: ${index * 50}ms">
                        ${badge}
                        <div class="flex flex-col md:flex-row">
                            <div class="flex-1 p-6 md:p-8">${legsHtml}</div>
                            <div class="bg-gray-50 p-6 w-full md:w-56 flex flex-row md:flex-col justify-between items-center md:justify-center border-t md:border-t-0 md:border-l border-dashed border-gray-200 group-hover:bg-green-50/30 transition-colors">
                                <div class="text-right md:text-center mb-0 md:mb-6"><p class="text-xs text-red-400 line-through font-medium mb-1">PKR ${Math.round(originalPrice).toLocaleString()}</p><p class="text-2xl md:text-3xl font-black text-green-600 leading-none tracking-tight">${Math.round(finalPrice).toLocaleString()}</p><div class="bg-red-500 text-white text-[10px] px-2 py-1 rounded shadow-sm font-bold inline-block mt-2">-40% SAVE</div></div>
                                <button onclick="selectFlight(${startIndex + index}, ${finalPrice})" class="bg-gray-900 hover:bg-green-600 text-white py-3 px-6 rounded-xl text-sm font-bold shadow-lg transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2 w-auto md:w-full justify-center"><i class="fab fa-whatsapp text-lg"></i> <span>Book Now</span></button>
                            </div>
                        </div>
                    </div>`;
                container.innerHTML += card;
            });
            updatePaginationControls(page, Math.ceil(allFlightsData.length / itemsPerPage));
            paginationContainer.classList.remove('hidden');
        }

        function updatePaginationControls(current, total) {
            const container = document.getElementById('pageNumbers');
            container.innerHTML = '';
            document.getElementById('prevBtn').disabled = current === 1;
            document.getElementById('prevBtn').classList.toggle('opacity-50', current === 1);
            document.getElementById('nextBtn').disabled = current === total;
            document.getElementById('nextBtn').classList.toggle('opacity-50', current === total);
            for(let i = 1; i <= total; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.onclick = () => changePage(i);
                if(i === current) { btn.className = "page-btn page-btn-active"; } 
                else { btn.className = "page-btn page-btn-inactive"; }
                container.appendChild(btn);
            }
        }

        function changePage(target) {
            const total = Math.ceil(allFlightsData.length / itemsPerPage);
            if (target === 'prev' && currentPage > 1) { currentPage--; } 
            else if (target === 'next' && currentPage < total) { currentPage++; } 
            else if (typeof target === 'number') { currentPage = target; }
            renderPage(currentPage);
            document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function selectFlight(globalIndex, finalPrice) {
            const flight = allFlightsData[globalIndex];
            const originalPrice = Math.round(flight.price.total).toLocaleString();
            const formattedFinal = Math.round(finalPrice).toLocaleString();
            const phoneNumber = "923306265440"; 
            let flightDetailsMsg = "";
            flight.itineraries.forEach((it, idx) => {
                const segs = it.segments;
                const f = segs[0];
                const l = segs[segs.length - 1];
                let carrier = f.carrierCode;
                if(flight.isScraper) carrier = f.carrierCode; 
                flightDetailsMsg += `\n‚úàÔ∏è *Flight:* ${carrier} ${f.number}\n   From: ${f.departure.iataCode} (${f.departure.at.split('T')[1].substr(0,5)})\n   To:     ${l.arrival.iataCode} (${l.arrival.at.split('T')[1].substr(0,5)})\n   Date: ${f.departure.at.split('T')[0]}\n`;
            });
            const message = `*New Booking Request* üé´\n------------------${flightDetailsMsg}------------------\nüè∑Ô∏è *Discount:* 40% OFF Applied\n‚ùå *Old Price:* ${originalPrice} PKR\n‚úÖ *Final Deal:* ${formattedFinal} PKR\n\nI would like to proceed with this booking.`;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const baseUrl = isMobile ? 'https://api.whatsapp.com/send' : 'https://web.whatsapp.com/send';
            window.open(`${baseUrl}?phone=${phoneNumber}&text=${encodeURIComponent(message)}`, '_blank');
        }

        function showLoading(isLoading) {
            const btnLoader = document.getElementById('btnLoader');
            const btnText = document.getElementById('btnText');
            if (isLoading) { btnLoader.classList.remove('hidden'); btnText.textContent = "Searching..."; } 
            else { btnLoader.classList.add('hidden'); btnText.textContent = "Search Flights"; }
        }

        function showError(msg) {
            const container = document.getElementById('errorContainer');
            const text = document.getElementById('errorText');
            container.classList.remove('hidden');
            text.innerHTML = msg.includes("Failed to fetch") ? "<strong>Network Connection Failed</strong><br>Check if your Local Python Server is running!" : msg;
        }

        function clearUI() {
            document.getElementById('resultsArea').innerHTML = '';
            document.getElementById('paginationContainer').classList.add('hidden');
            document.getElementById('errorContainer').classList.add('hidden');
        }
    </script>
</body>
</html>
